<!-- ============================================
     PROFESSIONAL NAVBAR
     ============================================ -->
<nav class="navbar navbar-expand-lg fixed-top navbar-modern" role="navigation">
  <div class="container-fluid">
    <!-- Brand -->
    <a class="navbar-brand" [routerLink]="['/dashboard']">
      <div class="brand-container">
        <img src="assets/images/logo.png" alt="Logo" class="brand-logo" />
        <span class="brand-text">Plataforma Inclusiva</span>
      </div>
    </a>

    <!-- Mobile Actions -->
    <div class="d-flex d-lg-none align-items-center gap-2">
      <button
        class="btn-icon"
        (click)="toggleTheme()"
        aria-label="Cambiar tema"
      >
        <i
          class="bi"
          [ngClass]="themeService.currentTheme ? 'bi-sun-fill' : 'bi-moon-fill'"
        ></i>
      </button>
      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navbarNav"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>

    <!-- Main Nav -->
    <div class="collapse navbar-collapse" id="navbarNav">
      <!-- Left Navigation -->
      <ul class="navbar-nav">
        <li class="nav-item">
          <a
            class="nav-link"
            [routerLink]="['/dashboard']"
            routerLinkActive="active"
            [routerLinkActiveOptions]="{ exact: true }"
          >
            <i class="bi bi-grid-fill"></i>
            <span>Dashboard</span>
          </a>
        </li>

        <li class="nav-item dropdown">
          <a
            class="nav-link dropdown-toggle"
            href="#"
            (click)="toggleDropdown('ajustes', $event)"
            role="button"
            aria-expanded="false"
          >
            <i class="bi bi-sliders"></i>
            <span>Ajustes</span>
          </a>
          <ul
            class="dropdown-menu"
            [ngClass]="{ show: openDropdown === 'ajustes' }"
          >
            <li *ngIf="isAdmin">
              <a class="dropdown-item" [routerLink]="['/ajustes/ong/crear']">
                <i class="bi bi-plus-circle"></i>
                <span>Crear Ajuste</span>
              </a>
            </li>
            <li *ngIf="!isAdmin">
              <a class="dropdown-item" [routerLink]="['/ajustes/create']">
                <i class="bi bi-plus-circle"></i>
                <span>Crear Ajuste</span>
              </a>
            </li>
            <li *ngIf="isAdmin">
              <a class="dropdown-item" [routerLink]="['/ajustes']">
                <i class="bi bi-card-list"></i>
                <span>Listar Ajustes</span>
              </a>
            </li>
            <li>
              <a class="dropdown-item" [routerLink]="['/ajustes/mis-ajustes']">
                <i class="bi bi-person-check"></i>
                <span>Mis Ajustes</span>
              </a>
            </li>
          </ul>
        </li>

        <li class="nav-item dropdown" *ngIf="isAdmin">
          <a
            class="nav-link dropdown-toggle"
            href="#"
            (click)="toggleDropdown('admin', $event)"
            role="button"
            aria-expanded="false"
          >
            <i class="bi bi-gear-fill"></i>
            <span>Admin</span>
          </a>
          <ul
            class="dropdown-menu"
            [ngClass]="{ show: openDropdown === 'admin' }"
          >
            <li>
              <a class="dropdown-item" [routerLink]="['/admin/usuarios']">
                <i class="bi bi-people-fill"></i>
                <span>Usuarios</span>
              </a>
            </li>
            <li>
              <a class="dropdown-item" [routerLink]="['/search']">
                <i class="bi bi-search"></i>
                <span>Buscar</span>
              </a>
            </li>
            <li>
              <a class="dropdown-item" [routerLink]="['/verificacion/create']">
                <i class="bi bi-shield-check"></i>
                <span>Verificación</span>
              </a>
            </li>
          </ul>
        </li>
      </ul>

      <!-- Center Search (Admin only, Desktop) -->
      <div class="nav-search d-none d-lg-flex" *ngIf="isAdmin">
        <div class="search-container" [class.focused]="isSearchFocused">
          <i class="bi bi-search search-icon"></i>
          <input
            type="text"
            class="search-input"
            placeholder="Buscar ajustes, usuarios, estados..."
            [(ngModel)]="searchTerm"
            (input)="filterAjustes()"
            (focus)="onSearchFocus()"
            (blur)="onSearchBlur()"
            aria-label="Buscar ajustes"
          />
          <button
            *ngIf="searchTerm"
            class="search-clear"
            (click)="clearSearch()"
            aria-label="Limpiar búsqueda"
          >
            <i class="bi bi-x"></i>
          </button>
        </div>
      </div>

      <!-- Right Actions -->
      <ul class="navbar-nav ms-auto">
        <!-- Theme Toggle Desktop -->
        <li class="nav-item d-none d-lg-block">
          <button
            class="btn-icon"
            (click)="toggleTheme()"
            aria-label="Cambiar tema"
            title="Cambiar tema"
          >
            <i
              class="bi"
              [ngClass]="
                themeService.currentTheme ? 'bi-sun-fill' : 'bi-moon-fill'
              "
            ></i>
          </button>
        </li>

        <!-- Feedback (Admin only) -->
        <li class="nav-item" *ngIf="isAdmin">
          <a
            class="btn btn-feedback"
            [routerLink]="['/create-feedback']"
            title="Enviar Feedback"
          >
            <i class="bi bi-chat-square-text"></i>
            <span class="d-none d-sm-inline">Feedback</span>
          </a>
        </li>

        <!-- Historial -->
        <li class="nav-item">
          <button
            class="btn-icon position-relative"
            (click)="toggleHistorial()"
            aria-label="Historial"
            title="Ver historial"
          >
            <i class="bi bi-clock-history"></i>
            <span
              class="notification-badge"
              *ngIf="getUnreadNotificationsCount() > 0"
            >
              {{
                getUnreadNotificationsCount() > 99
                  ? "99+"
                  : getUnreadNotificationsCount()
              }}
            </span>
          </button>
        </li>

        <!-- User Menu -->
        <li class="nav-item dropdown">
          <a
            class="nav-link user-menu"
            href="#"
            (click)="toggleUserMenu($event)"
            role="button"
            aria-expanded="false"
          >
            <div class="user-avatar">
              <i class="bi bi-person-fill"></i>
            </div>
            <span class="d-none d-md-inline">Cuenta</span>
          </a>
          <ul
            class="dropdown-menu dropdown-menu-end"
            [ngClass]="{ show: userMenuOpen }"
          >
            <li>
              <a class="dropdown-item" [routerLink]="['/perfil']">
                <i class="bi bi-person-circle"></i>
                <span>Mi Perfil</span>
              </a>
            </li>
            <li><hr class="dropdown-divider" /></li>
            <li>
              <button class="dropdown-item text-danger" (click)="signOut()">
                <i class="bi bi-box-arrow-right"></i>
                <span>Cerrar Sesión</span>
              </button>
            </li>
          </ul>
        </li>
      </ul>

      <!-- Mobile Search (Admin) -->
      <div class="w-100 mt-3 d-lg-none" *ngIf="isAdmin">
        <div class="search-container">
          <i class="bi bi-search search-icon"></i>
          <input
            type="text"
            class="search-input"
            placeholder="Buscar ajustes..."
            [(ngModel)]="searchTerm"
            (input)="filterAjustes()"
            aria-label="Buscar ajustes"
          />
        </div>
      </div>
    </div>
  </div>
</nav>

<!-- ============================================
     MAIN CONTENT
     ============================================ -->
<main class="main-content">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner-container">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="loading-text">Cargando dashboard...</p>
    </div>
  </div>

  <!-- ============================================
       ADMIN VIEW
       ============================================ -->
  <div *ngIf="!isLoading && isAdmin" class="admin-view">
    <!-- Header with Stats -->
    <div class="dashboard-header">
      <div class="header-content">
        <h1 class="dashboard-title">Panel de Administración</h1>
        <p class="dashboard-subtitle">
          Gestiona y supervisa todas las solicitudes del sistema
        </p>
      </div>
      <div class="header-stats">
        <div class="stat-card stat-primary">
          <div class="stat-icon">
            <i class="bi bi-clipboard-check"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ totalAjustes }}</div>
            <div class="stat-label">Total</div>
          </div>
        </div>
        <div class="stat-card stat-warning">
          <div class="stat-icon">
            <i class="bi bi-clock"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ pendingAjustes }}</div>
            <div class="stat-label">Pendientes</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters and View Toggles -->
    <div class="controls-bar">
      <div class="filter-group">
        <button
          class="filter-btn"
          [class.active]="selectedFilter === 'all'"
          (click)="setFilter('all')"
          aria-label="Filtrar todos"
        >
          <span>Todos</span>
          <span class="filter-count">{{ ajustes.length }}</span>
        </button>
        <button
          class="filter-btn"
          [class.active]="selectedFilter === 'pendiente'"
          (click)="setFilter('pendiente')"
          aria-label="Filtrar pendientes"
        >
          <span>Pendientes</span>
          <span class="filter-count">{{ getPendingCount() }}</span>
        </button>
        <button
          class="filter-btn"
          [class.active]="selectedFilter === 'aprobado'"
          (click)="setFilter('aprobado')"
          aria-label="Filtrar aprobados"
        >
          <span>Aprobados</span>
          <span class="filter-count">{{ getApprovedCount() }}</span>
        </button>
        <button
          class="filter-btn"
          [class.active]="selectedFilter === 'rechazado'"
          (click)="setFilter('rechazado')"
          aria-label="Filtrar rechazados"
        >
          <span>Rechazados</span>
          <span class="filter-count">{{ getRejectedCount() }}</span>
        </button>
      </div>

      <div class="view-toggle">
        <button
          class="view-btn"
          [class.active]="viewMode === 'grid'"
          (click)="setViewMode('grid')"
          title="Vista de cuadrícula"
          aria-label="Vista de cuadrícula"
        >
          <i class="bi bi-grid-3x3-gap"></i>
        </button>
        <button
          class="view-btn"
          [class.active]="viewMode === 'list'"
          (click)="setViewMode('list')"
          title="Vista de lista"
          aria-label="Vista de lista"
        >
          <i class="bi bi-list-ul"></i>
        </button>
      </div>
    </div>

    <!-- Reports Section -->
    <section class="reports-section">
      <h3 class="section-title">
        <i class="bi bi-graph-up me-2"></i>
        Reportes Analíticos
      </h3>
      <div class="reports-grid">
        <a
          [routerLink]="['/reportes/cumplimiento']"
          class="report-card"
          aria-label="Ver reporte de cumplimiento"
        >
          <div class="report-icon bg-success">
            <i class="bi bi-check-circle-fill"></i>
          </div>
          <div class="report-content">
            <h4>Cumplimiento</h4>
            <p>Estado de cumplimiento por periodo</p>
          </div>
          <i class="bi bi-arrow-right report-arrow"></i>
        </a>

        <a
          [routerLink]="['/reportes/vencidos']"
          class="report-card"
          aria-label="Ver reporte de vencidos"
        >
          <div class="report-icon bg-danger">
            <i class="bi bi-exclamation-triangle-fill"></i>
          </div>
          <div class="report-content">
            <h4>Vencidos</h4>
            <p>Ajustes próximos a vencer</p>
          </div>
          <i class="bi bi-arrow-right report-arrow"></i>
        </a>

        <a
          [routerLink]="['/reportes/tiempos']"
          class="report-card"
          aria-label="Ver reporte de tiempos"
        >
          <div class="report-icon bg-info">
            <i class="bi bi-speedometer2"></i>
          </div>
          <div class="report-content">
            <h4>Tiempos</h4>
            <p>Ciclos de resolución</p>
          </div>
          <i class="bi bi-arrow-right report-arrow"></i>
        </a>
      </div>
    </section>

    <!-- Notification Center -->
    <section class="notification-center-section">
      <h3 class="section-title">
        <i class="bi bi-bell me-2"></i>
        Centro de Notificaciones
      </h3>
      <app-notification-center
        [notifications]="notifications"
        [feedbacks]="feedbacks"
        [isLoading]="loadingNotifications"
        (notificationRead)="onNotificationRead($event)"
        (notificationDeleted)="onNotificationDeleted($event)"
        (refreshRequested)="refreshNotifications()"
        (itemDetails)="viewNotificationDetails($event)"
      >
      </app-notification-center>
    </section>

    <!-- Ajustes Grid/List -->
    <section class="ajustes-section">
      <h3 class="section-title">
        <i class="bi bi-folder me-2"></i>
        Solicitudes de Ajustes
      </h3>

      <!-- Grid View -->
      <div
        *ngIf="viewMode === 'grid' && hasFilteredResults"
        class="ajustes-grid"
        role="list"
      >
        <article
          *ngFor="let ajuste of filteredAjustes; trackBy: trackByAjusteId"
          class="ajuste-card-modern"
          (click)="viewAjusteDetails(ajuste)"
          role="listitem"
          tabindex="0"
          [attr.aria-label]="'Ajuste: ' + (ajuste.espacio || ajuste.tipoAjuste)"
        >
          <div class="card-header-modern">
            <div class="card-title-section">
              <h4 class="card-title-modern">
                {{ ajuste.espacio || ajuste.tipoAjuste }}
              </h4>
              <p
                class="card-subtitle-modern"
                *ngIf="ajuste.espacio && ajuste.tipoAjuste"
              >
                {{ ajuste.tipoAjuste }}
              </p>
            </div>
            <span
              class="badge-modern"
              [ngClass]="getStatusClass(ajuste.estado)"
            >
              <i class="bi" [ngClass]="getStatusIcon(ajuste.estado)"></i>
              {{ ajuste.estado }}
            </span>
          </div>

          <div class="card-body-modern">
            <p class="card-description">
              {{
                ajuste.observacion ||
                  ajuste.descripcion ||
                  ajuste.ajustesSugeridos ||
                  "Sin descripción disponible"
              }}
            </p>
          </div>

          <div class="card-footer-modern">
            <div class="footer-left">
              <div class="user-chip">
                <i class="bi bi-person-circle"></i>
                <span>{{ ajuste.usuario.nombreEmpresa || "Usuario" }}</span>
              </div>
            </div>
            <div class="footer-right">
              <span class="date-chip">
                <i class="bi bi-calendar-event"></i>
                {{ ajuste.fechaRecomendacion | date : "dd/MM/yyyy" }}
              </span>
            </div>
          </div>

          <div class="card-actions">
            <button
              class="action-btn"
              (click)="editAjuste(ajuste); $event.stopPropagation()"
              title="Editar ajuste"
              aria-label="Editar ajuste"
            >
              <i class="bi bi-pencil"></i>
            </button>
          </div>
        </article>
      </div>

      <!-- List View -->
      <div
        *ngIf="viewMode === 'list' && hasFilteredResults"
        class="ajustes-list"
        role="list"
      >
        <div
          class="list-item"
          *ngFor="let ajuste of filteredAjustes; trackBy: trackByAjusteId"
          role="listitem"
        >
          <div class="list-main" (click)="viewAjusteDetails(ajuste)">
            <div class="list-content">
              <h4 class="list-title">
                {{ ajuste.espacio || ajuste.tipoAjuste }}
              </h4>
              <p class="list-subtitle">
                {{
                  (ajuste.observacion || ajuste.descripcion || "Sin descripción")
                    | slice : 0 : 120
                }}{{ (ajuste.observacion || ajuste.descripcion || "").length > 120 ? "..." : "" }}
              </p>
            </div>
            <div class="list-meta">
              <span
                class="badge-modern"
                [ngClass]="getStatusClass(ajuste.estado)"
              >
                {{ ajuste.estado }}
              </span>
              <span class="list-date">{{
                ajuste.fechaRecomendacion | date : "dd/MM/yyyy"
              }}</span>
            </div>
          </div>
          <div class="list-actions">
            <button
              class="action-btn-sm"
              (click)="editAjuste(ajuste)"
              title="Editar"
              aria-label="Editar ajuste"
            >
              <i class="bi bi-pencil"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="!hasFilteredResults" class="empty-state-modern">
        <div class="empty-icon">
          <i class="bi bi-inbox"></i>
        </div>
        <h3 class="empty-title">No hay resultados</h3>
        <p class="empty-text">
          <span *ngIf="isSearching"
            >No se encontraron ajustes que coincidan con tu búsqueda. Intenta
            con otros términos.</span
          >
          <span *ngIf="!isSearching && selectedFilter !== 'all'"
            >No hay ajustes con el estado seleccionado.</span
          >
          <span *ngIf="!isSearching && selectedFilter === 'all'"
            >Aún no hay ajustes registrados en el sistema.</span
          >
        </p>
      </div>
    </section>
  </div>

  <!-- ============================================
       USER VIEW
       ============================================ -->
  <div *ngIf="!isLoading && !isAdmin" class="user-view">
    <!-- Header -->
    <div class="dashboard-header">
      <div class="header-content">
        <h1 class="dashboard-title">Mis Ajustes Razonables</h1>
        <p class="dashboard-subtitle">
          Seguimiento y gestión de tus solicitudes
        </p>
      </div>
      <a
        [routerLink]="['/ajustes/create']"
        class="btn btn-primary-modern"
        aria-label="Nueva solicitud"
      >
        <i class="bi bi-plus-circle"></i>
        <span>Nueva Solicitud</span>
      </a>
    </div>

    <!-- Chart Section -->
    <section *ngIf="hasAjustes" class="chart-section">
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">Resumen de Estados</h3>
          <span class="chart-total">{{ ajustes.length }} Total</span>
        </div>
        <div class="chart-container">
          <div class="chart-wrapper">
            <div class="chart-center">
              <span class="center-value">{{ ajustes.length }}</span>
              <span class="center-label">Ajustes</span>
            </div>
            <canvas
              *ngIf="doughnutChartData"
              baseChart
              [data]="doughnutChartData"
              [type]="doughnutChartType"
              [options]="doughnutChartOptions"
              [plugins]="doughnutChartPlugins"
              aria-label="Gráfico de estados de ajustes"
            ></canvas>
          </div>
          <div class="chart-legend" role="list" aria-label="Leyenda del gráfico">
            <div
              class="legend-item"
              *ngFor="let item of chartLegendData"
              role="listitem"
            >
              <span
                class="legend-color"
                [style.background-color]="item.color"
                [attr.aria-label]="item.label"
              ></span>
              <span class="legend-label">{{ item.label }}</span>
              <span class="legend-value">{{ item.value }}</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Notification Center -->
    <section class="notification-center-section">
      <h3 class="section-title">
        <i class="bi bi-bell me-2"></i>
        Centro de Notificaciones
      </h3>
      <app-notification-center
        [notifications]="notifications"
        [feedbacks]="feedbacks"
        [isLoading]="loadingNotifications"
        (notificationRead)="onNotificationRead($event)"
        (notificationDeleted)="onNotificationDeleted($event)"
        (refreshRequested)="refreshNotifications()"
        (itemDetails)="viewNotificationDetails($event)"
      >
      </app-notification-center>
    </section>

    <!-- Empty State User -->
    <div *ngIf="!hasAjustes" class="empty-state-modern">
      <div class="empty-icon">
        <i class="bi bi-clipboard-check"></i>
      </div>
      <h3 class="empty-title">Comienza tu solicitud</h3>
      <p class="empty-text">
        Aún no has solicitado ningún ajuste razonable. Crea tu primera
        solicitud para comenzar el proceso.
      </p>
      <a
        [routerLink]="['/ajustes/create']"
        class="btn btn-primary-modern mt-3"
        aria-label="Crear primera solicitud"
      >
        <i class="bi bi-plus-circle"></i>
        <span>Crear Mi Primera Solicitud</span>
      </a>
    </div>
  </div>
</main>

<!-- ============================================
     CHATBOT BUTTON
     ============================================ -->
<button
  class="chatbot-fab"
  (click)="toggleChatbot()"
  aria-label="Abrir chatbot de asistencia"
  title="Asistente virtual"
>
  <i class="bi" [ngClass]="showChatbot ? 'bi-x-lg' : 'bi-chat-dots-fill'"></i>
</button>

<!-- ============================================
     CHATBOT PANEL
     ============================================ -->
<div
  class="chatbot-panel"
  [class.visible]="showChatbot"
  role="dialog"
  aria-label="Panel de chatbot"
>
  <app-chatbot (close)="toggleChatbot()"></app-chatbot>
</div>

<!-- ============================================
     HISTORIAL SIDEBAR
     ============================================ -->
<div
  class="overlay"
  [class.visible]="showHistorial"
  (click)="toggleHistorial()"
  aria-hidden="true"
></div>
<aside
  class="historial-sidebar"
  [class.visible]="showHistorial"
  role="complementary"
  aria-label="Historial de notificaciones"
>
  <div class="sidebar-header">
    <h3 class="sidebar-title">
      <i class="bi bi-clock-history me-2"></i>
      Historial
    </h3>
    <button
      class="btn-close-modern"
      (click)="toggleHistorial()"
      aria-label="Cerrar historial"
      title="Cerrar"
    >
      <i class="bi bi-x-lg"></i>
    </button>
  </div>
  <div class="sidebar-body">
    <app-historial-chatbot></app-historial-chatbot>
  </div>
</aside>