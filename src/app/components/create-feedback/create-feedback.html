<div class="feedback-page">
  <!-- Header -->
  <header class="page-header">
    <button
      class="link-back"
      type="button"
      (click)="goBack()"
      aria-label="Volver al dashboard"
    >
      <span class="icon" aria-hidden="true">←</span>
      <span>Volver al dashboard</span>
    </button>

    <h1 class="page-title">Crear Retroalimentación</h1>
    <p class="page-subtitle">
      Comparte una evaluación clara y constructiva sobre el ajuste razonable
      seleccionado. Tu retroalimentación ayuda a mejorar continuamente nuestros
      procesos y servicios.
    </p>
  </header>

  <!-- Main -->
  <main class="container">
    <!-- Live alert region for screen readers -->
    <div
      #alertRegion
      tabindex="-1"
      class="sr-only"
      aria-live="assertive"
      aria-atomic="true"
      role="status"
    >
      {{ errorMessage || successMessage }}
    </div>

    <!-- Visual alerts -->
    <div *ngIf="errorMessage" class="alert alert-error" role="alert">
      {{ errorMessage }}
    </div>
    <div *ngIf="successMessage" class="alert alert-success" role="status">
      {{ successMessage }}
    </div>

    <!-- Card / Form -->
    <form
      [formGroup]="form"
      (ngSubmit)="submit()"
      class="card"
      novalidate
      aria-label="Formulario de retroalimentación"
    >
      <div class="card-body">
        <div class="form-grid">
          <!-- Ajuste Razonable -->
          <div class="form-group">
            <label for="ajusteId">
              Seleccionar Ajuste
              <span class="req" aria-label="requerido">*</span>
            </label>
            <select
              id="ajusteId"
              formControlName="ajusteId"
              [disabled]="loadingAjustes"
              [attr.aria-invalid]="isFieldInvalid('ajusteId')"
              [attr.aria-describedby]="
                'ajusteHelp' + (isFieldInvalid('ajusteId') ? ' ajusteError' : '')
              "
            >
              <option value="" disabled>
                {{ loadingAjustes ? 'Cargando ajustes…' : '— Selecciona un
                ajuste —' }}
              </option>
              <option
                *ngFor="let ajuste of ajustesRazonables"
                [value]="ajuste.idAjuste"
              >
                {{ ajuste.tipoAjuste }}<span *ngIf="ajuste.espacio">
                  – {{ ajuste.espacio }}</span
                >
              </option>
            </select>

            <small id="ajusteHelp" class="help">
              Selecciona el ajuste razonable sobre el que deseas dar
              retroalimentación.
            </small>

            <div
              id="ajusteError"
              class="field-error"
              *ngIf="isFieldInvalid('ajusteId')"
              role="alert"
            >
              {{ getFieldError('ajusteId') }}
            </div>
          </div>

          <!-- Calificación con Estrellas -->
          <div class="form-group">
            <label id="ratingLabel">
              Calificación <span class="req" aria-label="requerido">*</span>
            </label>

            <div
              class="stars"
              role="radiogroup"
              aria-labelledby="ratingLabel"
              aria-describedby="ratingHelp"
              [attr.aria-required]="true"
            >
              <ng-container *ngFor="let starValue of stars">
                <input
                  class="sr-only"
                  type="radio"
                  [id]="'star-' + starValue"
                  [value]="starValue"
                  name="calificacion"
                  [checked]="form.get('calificacion')?.value === starValue"
                  (change)="setRating(starValue)"
                />
                <label
                  class="star"
                  [class.active]="(form.get('calificacion')?.value ?? 0) >= starValue"
                  tabindex="0"
                  [attr.for]="'star-' + starValue"
                  (keydown.enter)="setRating(starValue); $event.preventDefault()"
                  (keydown.space)="setRating(starValue); $event.preventDefault()"
                  [attr.aria-label]="starValue + (starValue === 1 ? ' estrella' : ' estrellas')"
                  role="radio"
                  [attr.aria-checked]="form.get('calificacion')?.value === starValue"
                >
                  ★
                </label>
              </ng-container>
            </div>

            <small id="ratingHelp" class="help">
              {{ form.get('calificacion')?.value }}/5 – {{ ratingLabel }}
            </small>
          </div>

          <!-- Comentario -->
          <div class="form-group form-group--full">
            <label for="comentario">
              Comentario <span class="req" aria-label="requerido">*</span>
            </label>
            <textarea
              id="comentario"
              formControlName="comentario"
              rows="6"
              placeholder="Describe tu experiencia con este ajuste razonable. Sé específico sobre qué funcionó bien, qué podría mejorar, y cualquier sugerencia que tengas para optimizar el proceso..."
              [attr.aria-invalid]="isFieldInvalid('comentario')"
              [attr.aria-describedby]="
                'comentarioHelp contadorComentario' + 
                (isFieldInvalid('comentario') ? ' comentarioError' : '')
              "
              maxlength="500"
            ></textarea>

            <small id="comentarioHelp" class="help">
              Sé específico y constructivo: menciona qué funcionó bien y qué se
              podría mejorar.
            </small>

            <div
              id="contadorComentario"
              class="counter"
              [attr.aria-live]="comentarioLength > 450 ? 'polite' : 'off'"
            >
              {{ comentarioLength }} / 500 caracteres
              <span *ngIf="comentarioLength > 450" class="sr-only">
                , te quedan {{ 500 - comentarioLength }} caracteres
              </span>
            </div>

            <div
              id="comentarioError"
              class="field-error"
              *ngIf="isFieldInvalid('comentario')"
              role="alert"
            >
              {{ getFieldError('comentario') }}
            </div>
          </div>

          <!-- Visibilidad para el Empleador -->
          <div class="form-group">
            <label for="visibleEmpleador"> Visible para el empleador </label>

            <label
              class="switch"
              aria-label="Alternar visibilidad para el empleador"
            >
              <input
                type="checkbox"
                id="visibleEmpleador"
                formControlName="visibleEmpleador"
                role="switch"
                [attr.aria-checked]="form.get('visibleEmpleador')?.value"
                aria-describedby="visibilidadHelp"
              />
              <span class="slider"></span>
            </label>

            <small id="visibilidadHelp" class="help">
              <span *ngIf="form.get('visibleEmpleador')?.value">
                ✓ El empleador podrá ver esta retroalimentación y tus
                comentarios.
              </span>
              <span *ngIf="!form.get('visibleEmpleador')?.value">
                ✗ Esta retroalimentación será privada y solo visible para el
                sistema.
              </span>
            </small>
          </div>
        </div>
      </div>

      <!-- Footer con acciones -->
      <div class="card-footer">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="goBack()"
          [disabled]="loading"
          aria-label="Cancelar y volver al dashboard"
        >
          Cancelar
        </button>

        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="loading || form.invalid"
          [attr.aria-busy]="loading"
          [attr.aria-disabled]="loading || form.invalid"
        >
          <span class="spinner" *ngIf="loading" aria-hidden="true"></span>
          <span>{{ loading ? 'Enviando…' : 'Enviar Retroalimentación' }}</span>
        </button>
      </div>
    </form>
  </main>
</div>
